{% spaceless %}
{% load static %}
{% load cache %}
{% load compress %}
{% load evaluation_filters %}
{% load navbar_templatetags %}
{% load sass_tags %}

{% endspaceless %}<!DOCTYPE html>
<html>
<head>
    {% block header %}
        <title>{% block title %}EvaP{% endblock %}</title>

        {% compress css %}
            <link rel="stylesheet" href="{% sass_src 'css/evap-variables.scss' %}" />
            <link rel="stylesheet" href="{% sass_src 'font-awesome/scss/font-awesome.scss' %}" />
            <link rel="stylesheet" href="{% get_static_prefix %}css/select2.min.css" />
            <link rel="stylesheet" href="{% get_static_prefix %}css/dataTables.bootstrap.css" />
            <link rel="stylesheet" href="{% get_static_prefix %}css/bootstrap-datetimepicker.min.css" />
            <link rel="stylesheet" href="{% sass_src 'css/evap.scss' %}" />
        {% endcompress %}
        <link rel="shortcut icon" href="{% get_static_prefix %}images/favicon.ico" />
    {% endblock %}
</head>
<body>
{% block modals %}
{% endblock %}

{% get_current_language as LANGUAGE_CODE %}
{% cache 3600 navbar request.session.session_key LANGUAGE_CODE %}
    {% include_navbar user %}
{% endcache %}

<div class="visible-print-block"><img class="print-brand-image" src="{% get_static_prefix %}images/evap.png" alt="{% trans "Evaluation Platform" %}"></div>

<div class="container">
    {% if user.is_staff or user.is_grade_publisher %}
        <div class="row">
            <div class="col-md-12">
                <ol class="breadcrumb">
                    {% block breadcrumb %}<li class="breadcrumb-item"><a href="/">{% trans "EvaP" %}</a></li>{% endblock %}
                </ol>
            </div>
        </div>
    {% endif %}

    {% for message in messages %}
    <div class="alert alert-{{ message.tags|message_class }} alert-dismissable">
        <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&#215;</button>
        {{ message }}
    </div>
    {% endfor %}

    {% block rawcontent %}
        <div class="row">
            <div class="col-md-12">
                <div>
                    {% block content %}
                    {% endblock %}
                </div>
            </div>
        </div>
    {% endblock %}
</div>

<div class="footer fixed-bottom d-flex hidden-print">
    <span class="mr-auto">
        <a href="{{ TRACKER_URL }}" target="_blank">{% trans "EvaP evaluation platform" %}</a>
        &nbsp;&middot;&nbsp;
        {% if LEGAL_NOTICE_ACTIVE %}
            <a href="{% url 'evaluation:legal_notice' %}">{% trans "Legal Notice" %}</a>
            &nbsp;&middot;&nbsp;
        {% endif %}
        <a href="{% url 'evaluation:faq' %}">{% trans "FAQ"%}</a>
        &nbsp;&middot;&nbsp;
        {% if request.user.is_authenticated %}
            {% trans "Logged in as" %} {{ request.user.full_name }}
        {% else %}
            {% trans "Not logged in" %}
        {% endif %}
    </span>
    {% if user.is_authenticated %}
        <span class="feedback-button" id="feedback-button">
            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#feedback-modal">
                {% trans "Problems/Feedback" %}
            </button>
        </span>
    {% endif %}
</div>

{% if user.is_authenticated %}
    <div id="feedback-modal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="feedback-div">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">{% trans "Feedback" %}</h4>
                </div>
                <form id="feedback-form">
                    <div class="modal-body">
                        {% trans "You are welcome to submit feedback regarding the evaluation platform or the evaluation of specific courses. Please let us know how we can improve your experience on EvaP." %}
                        <br /><br />
                        <div class="form-group">
                            <label for="sender-email" class="control-label">{% trans "Email" %}:</label>
                            <input type="text" class="form-control" id="sender-email" disabled value="{{ request.user.email }}">
                        </div>
                        <label for="message-text" class="control-label">{% trans "Message" %}:</label>
                        <textarea class="form-control" id="message-text" style="resize:vertical;min-height:150px;"></textarea>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans "Cancel" %}</button>
                        <input id="feedback-submit-button" type="submit" class="btn btn-primary" value="{% trans "Send" %}">
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endif %}

{% compress js %}
    <script type="text/javascript" src="{% get_static_prefix %}js/jquery-2.1.3.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/moment.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/locale/moment_de.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/bootstrap-datetimepicker.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/tether.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}bootstrap/dist/js/bootstrap.min.js"></script>

    <script type="text/javascript" src="{% get_static_prefix %}js/select2.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/locale/select2_de.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/locale/select2_en.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/plugins/jquery.formset.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/Sortable.min.js"></script>
    <script type="text/javascript" src="{% get_static_prefix %}js/sortable_query_binding.js"></script>

    <script type="text/javascript" src="{% get_static_prefix %}js/csrf_utils.js"></script>
{% endcompress %}

<script type="text/javascript">
    // activate topbar
    $('#topbar').dropdown();

    // activate tooltips
    $('[data-toggle="tooltip"]').tooltip({container: 'body', html: true, trigger: 'hover'});

    // These are workarounds around incompatibilities of django, django-dynamic-formsets, and select2.
    // select2 can't handle already select2'd forms that were copies made by
    // django-dynamic-formsets' "add another" button, so we take a copy of a non-select2'd form here
    var template_form = $(".select2tr").last().clone();

    // later we use this class to give this to django-dynamic-formsets
    // as template and to make sure it does not get select2'd
    template_form.addClass("form-template").css("display", "none");
    // for some reason django-dynamic-formsets does not hide the checkbox like it should
    template_form.find(':checkbox').last().attr("type", "hidden");
    // For some reason, django validates this template if it's part of the form, so we insert the copy outside of the form.
    template_form.insertAfter($('.select2form'));

    // put this into a function for later re-use
    apply_select2 = function(elem) {
        elem.select2({
            language: "{{ LANGUAGE_CODE }}",
            placeholder: "{% trans "Please select..." %}",
            minimumResultsForSearch: 15,});
    };
    apply_select2($('select').not('.form-template select').not('[disabled]'));

    // don't use the placeholder text on disabled select2 elements
    apply_select2_disabled = function(elem) {
        elem.select2();
    };
    apply_select2_disabled($('select[disabled]').not('.form-template select'));

    // run the bootstrap datepicker plugin
    $("input[name*='end_date']:not([readonly='True'])").datetimepicker({
        locale: "{{ LANGUAGE_CODE }}",
        format: "YYYY-MM-DD",
        sideBySide: true
    });
    $("input[name*='start_date']:not([readonly='True'])").datetimepicker({
        locale: "{{ LANGUAGE_CODE }}",
        format: "YYYY-MM-DD HH:mm",
        sideBySide: true
    });

    // scroll content to show below navbar
    var navbar_height = 50;
    var shiftWindow = function(){
        setTimeout(function(){
            window.scrollBy(0, -navbar_height);
        }, 0);
    };
    if (location.hash)
        shiftWindow();
    window.addEventListener("hashchange", shiftWindow);

    // fix scrolling to required field when the browser does form validation
    // taken from http://stackoverflow.com/questions/19814673/html5-input-required-scroll-to-input-with-fixed-navbar-on-submit
    var delay = 0;
    var offset = 150;
    document.addEventListener('invalid', function(e){
       $(e.target).addClass("invalid");
       $('html, body').animate({scrollTop: $($(".invalid")[0]).offset().top - offset }, delay);
    }, true);
    document.addEventListener('change', function(e){
       $(e.target).removeClass("invalid")
    }, true);

    // If activated, make the user confirm he wants to leave the page by displaying a popup.
    var preventAccidentalClosing = false;
    $(window).bind('beforeunload', function(){
        if (preventAccidentalClosing) {
            return "{% trans "Are you sure you want to leave?" %}";
        }
    });

    // feedback form submission
    $('#feedback-form').on('submit', function(event){
        event.preventDefault();

        message = $('#message-text').val();

        $('#feedback-modal').modal('hide');

        if (message.trim() == "")
            return;

        var feedbackButton = $('#feedback-button button');
        var originalText = feedbackButton.html();
        feedbackButton.html("Sending...")

        $.ajax({
            url : "/feedback/send",
            type : "POST",
            data : { message: message },
            success : function(json) {
                feedbackButton.html('{% trans "Message sent!" %}');
                $('#message-text').val("")
                setTimeout(function(){
                    feedbackButton.html(originalText);
                }, 3000);
            },
            error : function(json) {
                feedbackButton.html('{% trans "Sending failed, sorry!" %}');
                setTimeout(function(){
                    feedbackButton.html(originalText);
                }, 3000);
            }
        });
    });
</script>

{% block additional_javascript %}{% endblock %}
</body>
</html>
