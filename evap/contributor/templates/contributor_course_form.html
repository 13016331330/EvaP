{% extends "contributor_base.html" %}

{% load bootstrap3 %}
{% load evaluation_filters %}

{% block breadcrumb %}
    {{ block.super }}
    <li>{{ course.name }}</li>
{% endblock %}

{% block content %}
    {{ block.super }}
    <form method="POST" class="form-horizontal multiselect-form select2form" id="course-form">
        {% csrf_token %}

        {% include 'course_form_general_questions.html' with course=course course_form=form %}

        {% include "contribution_formset.html" with formset=formset staff=False editable=editable%}

        <fieldset>
            <legend>{% trans "Students" %}</legend>
            <p>{% trans "These students should be participating in your course. If this data is not correct, e.g. when students are missing from the list, please contact the student representatives." %}</p>
            <ul>
                {% for p in course.participants.all|dictsort:"last_name" %}
                    <li>{{ p.full_name }}</li>
                {% endfor %}
            </ul>
        </fieldset>
        <div class="form-group well">
            <div class="col-sm-offset-2 col-sm-6">
                {% if editable %}
                    <button name="operation" value="save" type="submit" onclick="preventAccidentalClosing = false;" class="btn btn-primary">{% trans "Save"%}</button>
                    <button id="preview-button" name="operation" formtarget="_blank"
                    value="preview" type="submit" onclick="preventAccidentalClosing = false;"
                    class="btn btn-primary" data-toggle="modal" data-target=".bs-example-modal-sm">{% trans "Preview"%}</button>
                    {# webtest does not allow submission with value "approve" if no such button exists #}
                    <button style="display: none" name="operation" value="approve" type="submit" />
                    <button onclick="preventAccidentalClosing = false; show_approve_course_modal(0, '');" type="button" class="btn btn-success">{% trans "Save and approve"%}</button>
                {% endif %}
                <a href="{% url "contributor:index" %}" class="btn btn-default">{% if edit %} {% trans "Cancel" %} {% else %} {% trans "Back" %} {% endif %}</a>
            </div>
        </div>
    </form>

<div class="modal fade bs-example-modal-sm" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel">
  <div class="modal-dialog modal-sm" role="document">
    <div class="modal-content">
      Creating preview, please wait...
    </div>
  </div>
</div>
{% endblock %}

{% block modals %}
    {{ block.super }}
    {% trans "Approve course" as title %}
    {% trans "Do you want to approve this course? This will allow the student representatives to proceed with the preparation, but you won't be able to make any further changes." as question %}
    {% trans "Approve course" as action_text %}
    {% include "confirmation_modal.html" with modal_id="approve_course_modal" title=title question=question action_text=action_text btn_type="primary" %}
    <script type="text/javascript">
        function approve_course_modal_action(data_id) {
            $('#course-form').append('<input type="hidden" name="operation" value="approve">');
            $('#course-form').submit();
        };
    </script>
{% endblock %}

{% block additional_javascript %}
    {% include "evap_course_edit_js.html" %}
    {% if editable %}
        <script type="text/javascript"> preventAccidentalClosing = true; </script>

        <script type="text/javascript">

            $('#course-form').on('click', ":button[value='preview']", function(event){
                event.preventDefault();

                $("#preview-button").html("Please wait...")

                $.ajax({
                    type : "POST",
                    data : $('#course-form').serialize() + "&operation=validate",
                    success : function(response) {
                        // document.write re-creates window.
                        // this here saves previewWindow so it doesn't get lost
                        previewWindow = window.previewWindow
                        document.open();
                        document.write(response);
                        document.close();
                        window.previewWindow = previewWindow;
                    },
                    error : function(response) { /* TODO?? */ }
                });


                $.ajax({
                    type : "POST",
                    data : $('#course-form').serialize() + "&operation=preview",
                    success : function(response) {
                        if (typeof(window.previewWindow) === 'undefined' || window.previewWindow.closed == true)
                            window.previewWindow = window.open('','mywindow');
                        window.previewWindow.document.write(response);
                        window.previewWindow.document.close();
                        // window.previewWindow.opener.focus();
                    },
                    error : function(response) { /* form was invalid, ignore that */ }
                });
            });
        </script>
    {% endif %}
{% endblock %}
